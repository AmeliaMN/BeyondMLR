---
title: "Chapter 8"
subtitle: "Introduction to Multilevel Models"
output:
  pdf_document:
    number_sections: yes
  html_document: default
---

```{r,include=F}
if(knitr::is_html_output()){options(knitr.table.format = "html")} else {options(knitr.table.format = "latex")}
```

# Two Level Longitudinal Data {#ch-lon}

## Learning objectives

  After finishing this chapter, you should be able to:

- Recognize longitudinal data as a special case of multilevel data, with time at Level One.
- Consider patterns of missingness and implications of that missing data on multilevel analyses.
- Apply exploratory data analysis techniques specific to longitudinal data.
- Build and understand a taxonomy of models for longitudinal data.
- Interpret model parameters in multilevel models with time at Level One.
- Compare models, both nested and not, with appropriate statistical tests and summary statistics.
- Consider different ways of modeling the variance-covariance structure in longitudinal data.

```{r load_packages9, message = FALSE}
# Packages required for Chapter 9
library(GGally)
library(data.table)
library(Hmisc)
library(mice)
library(lattice)
library(nlme)
library(reshape2)
library(MASS)
library(mnormt)
library(lme4)
library(gridExtra) 
library(knitr)
library(kableExtra)
library(tidyverse)
```

```{r, include=FALSE}
Variable <- c("Intercept", "Person-Level predictors", "Female", "Married", "Separated or divorced", "Single", "Homeowner", "Latino", "Black", "Mobility", "Age", "Years in neighborhood", "SES", "Neighborhood-level predictors", "Concentrated disadvantage", "Immigrant concentration", "Residential stability", "Variance Components", "Within neighborhoods", "Between neighborhoods", "Percent of variance explained", "Within neighborhoods", "Between neighborhoods")
Coefficient <- c(3.523, " ", -0.012, -0.005, -0.045, -0.026, 0.122, 0.042, -0.029, -0.025, 0.0021, 0.0006, 0.035," ", -0.172, -0.037, 0.074, " ", 0.320, 0.026, " ", 3.2, 70.3)
SE2 <- c("0.013", " ", "0.015", "0.021", "0.026", "0.024", "0.020", "0.028", "0.030", "0.007", "0.0006", "0.0008", "0.008", " ", "0.016", "0.014", "0.013", " ", " ", " ", " ", " ", " ")
tratio <- c("263.20", " ", "-0.76", "-0.25", "-1.72", "-1.05", "6.04", "1.52", "-0.98", "-3.71", "3.47", "0.78", "4.64", " ", "-10.74", "-2.66", "5.61", " ", " ", " ", " ", " ", " ")
```

```{r, table4chp10, echo=FALSE}
table4chp10 <- data.frame(Variable, Coefficient, SE2, tratio)
colnames(table4chp10) <- c("Variable", "Coefficient", "SE",
                           "t ratio")
table4chp10[7,2] <- paste0("\\textbf{", table4chp10[7,2], "}")
table4chp10[11,2] <- paste0("\\textbf{", table4chp10[11,2], "}")
table4chp10[13,2] <- paste0("\\textbf{", table4chp10[13,2], "}")
table4chp10[15,2] <- paste0("\\textbf{", table4chp10[15,2], "}")
table4chp10[16,2] <- paste0("\\textbf{", table4chp10[16,2], "}")
kable(table4chp10, booktabs=T, escape=F,
      caption="Table 3: Correlates of collective efficacy from Sampson (1997)") %>%
  kable_styling(latex_options = "scale_down") %>%
  row_spec(c(2,14,18,21), bold=T) 
```

22. Table \@ref(tab:table5chp10) shows a portion of Table 4 from @Sampson1997. Describe the multilevel model that likely produced this table. State the primary result from this table in context. [Note that collective efficacy is a Level Three covariate in this table, summarized over an entire neighborhood.]

```{r, include=FALSE}
Variable2 <- c("Concentrated disadvantage","Immigrant concentration","Residential stability","Collective efficacy")
Coefficient2 <- c("0.277","0.041","-0.102"," ")
SE3 <- c("0.021","0.017","0.015"," ")
t2 <- c("13.30","2.44","-6.95"," ")
Coefficient3 <- c("0.171","0.018","-0.056","-0.618")
SE4 <- c("0.024","0.016","0.016","0.104")
t3 <- c("7.24","1.12","-3.49","-5.95")
```

```{r, table5chp10, echo=FALSE}
table5chp10 <- data.frame(Variable2, Coefficient2, SE3 ,t2, Coefficient3, SE4, t3)
colnames(table5chp10) <- c("Variable","Coefficient","SE", "t", 
                           "Coefficient","SE", "t")
kable(table5chp10, booktabs=T, 
      caption="A portion of Table 4: Neighborhood correlates of perceived neighborhood violence from Sampson et al. (1997).") %>%
      add_header_above(c(" ","Model 1"=3, "Model 2"=3)) %>%
      add_header_above(c(" ","Social composition"=3, "Social comp and collective efficacy"=3)) %>%
      kable_styling(latex_options = "scale_down") %>%
      row_spec(1, bold=T) 

```

\begin{tiny}
\[  Cov(\textbf{Y}_{i}) = \left[
          \begin{array}{cccccc}
            Cov(\textbf{Y}_{i1}) & & & & & \\
            Cov(\textbf{Y}_{i1},\textbf{Y}_{i2}) & Cov(\textbf{Y}_{i2}) & & & & \\
            Cov(\textbf{Y}_{i1},\textbf{Y}_{i3}) & Cov(\textbf{Y}_{i2},\textbf{Y}_{i3}) & Cov(\textbf{Y}_{i3}) & & & \\
            Cov(\textbf{Y}_{i1},\textbf{Y}_{i4}) & Cov(\textbf{Y}_{i2},\textbf{Y}_{i4}) & Cov(\textbf{Y}_{i3},\textbf{Y}_{i4}) & Cov(\textbf{Y}_{i4}) & & \\
            Cov(\textbf{Y}_{i1},\textbf{Y}_{i5}) & Cov(\textbf{Y}_{i2},\textbf{Y}_{i5}) & Cov(\textbf{Y}_{i3},\textbf{Y}_{i5}) & Cov(\textbf{Y}_{i4},\textbf{Y}_{i5}) & Cov(\textbf{Y}_{i5}) & \\
            Cov(\textbf{Y}_{i1},\textbf{Y}_{i6}) & Cov(\textbf{Y}_{i2},\textbf{Y}_{i6}) & Cov(\textbf{Y}_{i3},\textbf{Y}_{i6}) & Cov(\textbf{Y}_{i4},\textbf{Y}_{i6}) & Cov(\textbf{Y}_{i5},\textbf{Y}_{i6}) & Cov(\textbf{Y}_{i6})
          \end{array} \right]. \]
\end{tiny}


We once again begin with the __unconditional means model__, in which there are no predictors at any level, in order to assess the amount of variation at each level. Here, Level Three is pot, Level Two is plant within pot, and Level One is time within plant. Using model formulations at each of the three levels, the unconditional means three-level model can be expressed as:

- Level One (timepoint within plant):

\begin{equation}
Y_{ijk} = a_{ij}+\epsilon_{ijk} \textrm{ where } \epsilon_{ijk}\sim N(0,\sigma^2)
(\#eq:initunun)
\end{equation}

- Level Two (plant within pot):

\begin{equation}
a_{ij} = a_{i}+u_{ij} \textrm{ where } u_{ij}\sim N(0,\sigma_{u}^{2})
(\#eq:initunun2)
\end{equation}

- Level Three (pot):

\begin{equation}
a_{i} = \alpha_{0}+\tilde{u}_{i} \textrm{ where } \tilde{u}_{i} \sim N(0,\sigma_{\tilde{u}}^{2})
(\#eq:initunun3)
\end{equation}

where the heights of plants from different pots are considered independent, but plants from the same pot are correlated as well as measurements at different times from the same plant.
