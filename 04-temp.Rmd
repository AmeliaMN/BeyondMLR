---
title: "Chapter 8"
subtitle: "Introduction to Multilevel Models"
output:
  pdf_document:
    number_sections: yes
  html_document: default
---

```{r,include=F}
if(knitr::is_html_output()){options(knitr.table.format = "html")} else {options(knitr.table.format = "latex")}
```

# Two Level Longitudinal Data {#ch-lon}

## Learning objectives

  After finishing this chapter, you should be able to:

- Recognize longitudinal data as a special case of multilevel data, with time at Level One.
- Consider patterns of missingness and implications of that missing data on multilevel analyses.
- Apply exploratory data analysis techniques specific to longitudinal data.
- Build and understand a taxonomy of models for longitudinal data.
- Interpret model parameters in multilevel models with time at Level One.
- Compare models, both nested and not, with appropriate statistical tests and summary statistics.
- Consider different ways of modeling the variance-covariance structure in longitudinal data.

```{r load_packages9, message = FALSE}
# Packages required for Chapter 9
library(GGally)
library(data.table)
library(Hmisc)
library(mice)
library(lattice)
library(nlme)
library(reshape2)
library(MASS)
library(mnormt)
library(lme4)
library(gridExtra) 
library(knitr)
library(kableExtra)
library(tidyverse)
```

```{r, include=FALSE}
Variable <- c("Intercept", "Person-Level predictors", "Female", "Married", "Separated or divorced", "Single", "Homeowner", "Latino", "Black", "Mobility", "Age", "Years in neighborhood", "SES", "Neighborhood-level predictors", "Concentrated disadvantage", "Immigrant concentration", "Residential stability", "Variance Components", "Within neighborhoods", "Between neighborhoods", "Percent of variance explained", "Within neighborhoods", "Between neighborhoods")
Coefficient <- c(3.523, " ", -0.012, -0.005, -0.045, -0.026, 0.122, 0.042, -0.029, -0.025, 0.0021, 0.0006, 0.035," ", -0.172, -0.037, 0.074, " ", 0.320, 0.026, " ", 3.2, 70.3)
SE2 <- c("0.013", " ", "0.015", "0.021", "0.026", "0.024", "0.020", "0.028", "0.030", "0.007", "0.0006", "0.0008", "0.008", " ", "0.016", "0.014", "0.013", " ", " ", " ", " ", " ", " ")
tratio <- c("263.20", " ", "-0.76", "-0.25", "-1.72", "-1.05", "6.04", "1.52", "-0.98", "-3.71", "3.47", "0.78", "4.64", " ", "-10.74", "-2.66", "5.61", " ", " ", " ", " ", " ", " ")
```

```{r, table4chp10, echo=FALSE}
table4chp10 <- data.frame(Variable, Coefficient, SE2, tratio)
colnames(table4chp10) <- c("Variable", "Coefficient", "SE",
                           "t ratio")
table4chp10[7,2] <- paste0("\\textbf{", table4chp10[7,2], "}")
table4chp10[11,2] <- paste0("\\textbf{", table4chp10[11,2], "}")
table4chp10[13,2] <- paste0("\\textbf{", table4chp10[13,2], "}")
table4chp10[15,2] <- paste0("\\textbf{", table4chp10[15,2], "}")
table4chp10[16,2] <- paste0("\\textbf{", table4chp10[16,2], "}")
kable(table4chp10, booktabs=T, escape=F,
      caption="Table 3: Correlates of collective efficacy from Sampson (1997)") %>%
  kable_styling(latex_options = "scale_down") 
```

22. Table \@ref(tab:table5chp10) shows a portion of Table 4 from @Sampson1997. Describe the multilevel model that likely produced this table. State the primary result from this table in context. [Note that collective efficacy is a Level Three covariate in this table, summarized over an entire neighborhood.]

```{r, include=FALSE}
Variable2 <- c("Concentrated disadvantage","Immigrant concentration","Residential stability","Collective efficacy")
Coefficient2 <- c("0.277","0.041","-0.102"," ")
SE3 <- c("0.021","0.017","0.015"," ")
t2 <- c("13.30","2.44","-6.95"," ")
Coefficient3 <- c("0.171","0.018","-0.056","-0.618")
SE4 <- c("0.024","0.016","0.016","0.104")
t3 <- c("7.24","1.12","-3.49","-5.95")
```

```{r, table5chp10, echo=FALSE}
table5chp10 <- data.frame(Variable2, Coefficient2, SE3 ,t2, Coefficient3, SE4, t3)
colnames(table5chp10) <- c("Variable","Coefficient","SE", "t", 
                           "Coefficient","SE", "t")
kable(table5chp10, booktabs=T, 
      caption="A portion of Table 4: Neighborhood correlates of perceived neighborhood violence from Sampson et al. (1997).") %>%
      add_header_above(c(" ","Model 1"=3, "Model 2"=3)) %>%
      add_header_above(c(" ","Social composition"=3, "Social comp and collective efficacy"=3)) %>%
      kable_styling(latex_options = "scale_down") %>%
      row_spec(1, bold=T) 

```

20. Table \@ref(tab:table4chp11) shows Table 2 from @Randall2014.  Let $Y_{ij}$ be the number of acute myocardial infarctions in subgroup $j$ from SLA $i$; write out the multilevel model that likely produced Table \@ref(tab:table4chp11).  How many fixed effects and variance components must be estimated?

```{r, include=FALSE}
blnkcol <- c("Aboriginal", "No(ref)", "Yes", "Age Group", "25-34 (ref)", "35-44", "45-54", "55-64", "65-74", "75-84", "Sex", "Male (ref)", "Female", "Year", "2002 (ref)", "2003", "2004", "2005", "2006", "2007")
RR <- c(" ", 1.00, 2.10, " ", 1.00, 6.01, 19.36, 40.29, 79.92, 178.75, " ", 1.00, 0.45, " ", 1.00, 1.00, 0.97, 0.91, 0.88, 0.88)
CI95 <- c(" ", " ", "1.98-2.23", " ", " ", "5.44-6.64", "17.58-21.31", "36.67-44.26", "72.74-87.80", "162.70-196.39", " ", " ", "0.44-0.45", " ", " ", "0.98-1.03", "0.95-0.99", "0.89-0.94", "0.86-0.91", "0.86-0.91")
Pvalcol <- c(" ", "<0.01", " ", " ", "<0.01", " ", " ", " ", " ", " ", " ", "<0.01", " ", " ", "<0.01", " ", " ", " ", " ", " ")
```

```{r, table4chp11, echo=FALSE}
table4chp11 <- data.frame(blnkcol, RR, CI95, Pvalcol)
colnames(table4chp11) <- c(" ", "RR", "95% CI", "p-Value")
table4chp11 <- table4chp11 %>%
  mutate(RR = ifelse(RR == "2.1" | RR == "0.45", 
                     cell_spec(RR, bold=T), RR))
kable(table4chp11, booktabs=T, escape=F,
      caption="Adjusted rate ratios for individual-level variables from the multilevel Poisson regression model with random intercept for area from Table 2 in Randall et al. (2014)") %>%
  kable_styling(latex_options = "scale_down") 
```

```{r, include=FALSE, eval=F}
blnkcol <- c("Aboriginal", "No(ref)", "Yes", "Age Group", "25-34 (ref)", "35-44", "45-54", "55-64", "65-74", "75-84", "Sex", "Male (ref)", "Female", "Year", "2002 (ref)", "2003", "2004", "2005", "2006", "2007")
RR <- c(" ", 1.00, 2.10, " ", 1.00, 6.01, 19.36, 40.29, 79.92, 178.75, " ", 1.00, 0.45, " ", 1.00, 1.00, 0.97, 0.91, 0.88, 0.88)
CI95 <- c(" ", " ", "1.98-2.23", " ", " ", "5.44-6.64", "17.58-21.31", "36.67-44.26", "72.74-87.80", "162.70-196.39", " ", " ", "0.44-0.45", " ", " ", "0.98-1.03", "0.95-0.99", "0.89-0.94", "0.86-0.91", "0.86-0.91")
Pvalcol <- c(" ", "<0.01", " ", " ", "<0.01", " ", " ", " ", " ", " ", " ", "<0.01", " ", " ", "<0.01", " ", " ", " ", " ", " ")
```

```{r, echo=FALSE, eval=F}
table4chp11 <- data.frame(blnkcol, RR, CI95, Pvalcol)
colnames(table4chp11) <- c(" ", "RR", "95% CI", "p-Value")
table4chp11 <- tibble(table4chp11) %>%
  format_cells(3, 2, "bold") %>%
  format_cells(13, 2, "bold") %>%
  format_cells(3, 3, "bold") %>%
  format_cells(6, 3, "bold") %>%
  format_cells(20, 3, "bold") %>%
  format_cells(5, 4, "bold") %>%
table4chp11[3,2] <- paste0("\\textbf{", table4chp11[3,2], "}")
table4chp11[13,2] <- paste0("\\textbf{", table4chp11[13,2], "}")
table4chp11[3,3] <- paste0("\\textbf{", table4chp11[3,3], "}")
table4chp11[6,3] <- paste0("\\textbf{", table4chp11[6,3], "}")
table4chp11[20,3] <- paste0("\\textbf{", table4chp11[20,3], "}")
table4chp11[5,4] <- paste0("\\textbf{", table4chp11[5,4], "}")
kable(table4chp11, booktabs=T, escape=F,
      caption="Adjusted rate ratios for individual-level variables from the multilevel Poisson regression model with random intercept for area from Table 2 in Randall et al. (2014)") %>%
  kable_styling(latex_options = "scale_down") %>%
  row_spec(c(1,4,11,14), bold=T)
```
